<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized AI Learning Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .api-setup {
            margin-bottom: 30px;
            padding: 25px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            border-left: 5px solid #fdcb6e;
        }

        .api-setup h3 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-setup input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            font-family: monospace;
        }

        .api-setup .help-text {
            margin-top: 10px;
            font-size: 14px;
            color: #856404;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
            width: 0%;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #4facfe;
        }

        .step h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="file"], input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="file"]:focus, input[type="text"]:focus, textarea:focus, select:focus {
            border-color: #4facfe;
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            min-height: 50px;
        }

        .tag {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .output-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #4facfe;
        }

        .slide-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .slide-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4facfe;
        }

        .slide-content {
            line-height: 1.6;
            color: #666;
            white-space: pre-wrap;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .file-info {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }

        .extracted-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Personalized AI Learning Platform</h1>
            <p>Transform your lecture slides with ChatGPT personalization</p>
        </div>

        <div class="main-content">
            <!-- API Setup -->
            <div class="api-setup">
                <h3>üîë OpenAI API Configuration</h3>
                <input type="password" id="apiKey" placeholder="Enter your OpenAI API key (sk-...)">
                <div class="help-text">
                    Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a>. 
                    Your key is stored locally and sent directly to OpenAI.
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Step 1: Upload Slides -->
            <div class="step">
                <h2><span class="step-number">1</span>Upload Lecture Slides</h2>
                <div class="form-group">
                    <label for="slideUpload">Select your PowerPoint or PDF slides:</label>
                    <input type="file" id="slideUpload" accept=".pptx,.pdf,.ppt,.txt" />
                    <div class="file-info" id="fileInfo" style="display: none;"></div>
                    <div class="extracted-content" id="extractedContent" style="display: none;"></div>
                </div>
            </div>

            <!-- Step 2: Student Background -->
            <div class="step">
                <h2><span class="step-number">2</span>Student Background</h2>
                <div class="form-group">
                    <label for="background">Academic/Professional Background:</label>
                    <select id="background">
                        <option value="">Select background...</option>
                        <option value="journalism">Journalism</option>
                        <option value="geography">Geography</option>
                        <option value="business">Business</option>
                        <option value="psychology">Psychology</option>
                        <option value="engineering">Engineering</option>
                        <option value="medicine">Medicine</option>
                        <option value="education">Education</option>
                        <option value="arts">Arts & Humanities</option>
                        <option value="science">Natural Sciences</option>
                        <option value="law">Law</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="experience">Experience Level:</label>
                    <select id="experience">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
            </div>

            <!-- Step 3: Interests -->
            <div class="step">
                <h2><span class="step-number">3</span>Personal Interests</h2>
                <div class="form-group">
                    <label for="interestsInput">Add interests (press Enter after each):</label>
                    <input type="text" id="interestsInput" placeholder="e.g., football, baking, Liverpool FC..." />
                    <div class="tags-input" id="interestsTags"></div>
                </div>
            </div>

            <!-- Step 4: Learning Preferences -->
            <div class="step">
                <h2><span class="step-number">4</span>Learning Preferences</h2>
                <div class="form-group">
                    <label for="learningStyle">Preferred Learning Style:</label>
                    <select id="learningStyle">
                        <option value="visual">Visual (diagrams, charts, images)</option>
                        <option value="practical">Practical (real-world examples)</option>
                        <option value="analytical">Analytical (detailed explanations)</option>
                        <option value="storytelling">Storytelling (narratives, case studies)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="complexity">Content Complexity:</label>
                    <select id="complexity">
                        <option value="simplified">Simplified explanations</option>
                        <option value="balanced">Balanced approach</option>
                        <option value="detailed">Detailed technical content</option>
                    </select>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="step">
                <button class="btn" id="generateBtn" onclick="generatePersonalizedContent()">
                    üöÄ Generate Personalized Content with ChatGPT
                </button>
            </div>

            <!-- Output Section -->
            <div class="output-section" id="outputSection">
                <h2>üìã Your Personalized Slides</h2>
                <div id="statusMessage"></div>
                <div id="slidePreview"></div>
                <div class="export-buttons">
                    <button class="btn" onclick="exportToPowerPoint()">üìä Export to PowerPoint</button>
                    <button class="btn" onclick="exportToPDF()">üìÑ Export to PDF</button>
                    <button class="btn" onclick="exportToText()">üìù Export as Text</button>
                    <button class="btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let interests = [];
        let uploadedFile = null;
        let extractedText = '';
        let personalizedContent = null;

        // PDF.js worker setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // File upload handler
        document.getElementById('slideUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadedFile = file;
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `üìé ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                
                // Extract text from file
                showStatus('üìÑ Extracting content from your file...', 'processing');
                try {
                    extractedText = await extractTextFromFile(file);
                    const contentDiv = document.getElementById('extractedContent');
                    contentDiv.textContent = extractedText.substring(0, 500) + (extractedText.length > 500 ? '...\n\n[Content truncated for preview]' : '');
                    contentDiv.style.display = 'block';
                    showStatus('‚úÖ Content extracted successfully!', 'success');
                } catch (error) {
                    showStatus('‚ùå Error extracting content: ' + error.message, 'error');
                }
                updateProgress();
            }
        });

        // Extract text from different file types
        async function extractTextFromFile(file) {
            const fileType = file.type || file.name.split('.').pop().toLowerCase();
            
            if (fileType.includes('pdf') || file.name.endsWith('.pdf')) {
                return await extractTextFromPDF(file);
            } else if (fileType.includes('powerpoint') || file.name.endsWith('.pptx') || file.name.endsWith('.ppt')) {
                return await extractTextFromPowerPoint(file);
            } else if (fileType.includes('text') || file.name.endsWith('.txt')) {
                return await file.text();
            } else {
                throw new Error('Unsupported file type. Please use PDF, PowerPoint, or text files.');
            }
        }

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                text += `\n\n--- Slide ${i} ---\n${pageText}`;
            }
            
            return text;
        }

        // Extract text from PowerPoint (simplified - in production you'd use a proper PPTX parser)
        async function extractTextFromPowerPoint(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                let text = '';
                let slideCount = 0;

                // Try to extract from slide files
                for (const [filename, zipEntry] of Object.entries(zip.files)) {
                    if (filename.startsWith('ppt/slides/slide') && filename.endsWith('.xml')) {
                        slideCount++;
                        const content = await zipEntry.async('string');
                        // Simple regex to extract text content (this is basic - a full parser would be better)
                        const textMatches = content.match(/<a:t[^>]*>([^<]*)<\/a:t>/g) || [];
                        const slideText = textMatches.map(match => match.replace(/<[^>]*>/g, '')).join(' ');
                        text += `\n\n--- Slide ${slideCount} ---\n${slideText}`;
                    }
                }

                if (text.trim() === '') {
                    throw new Error('No text content found in PowerPoint file');
                }

                return text;
            } catch (error) {
                throw new Error('Could not parse PowerPoint file. Please try converting to PDF first.');
            }
        }

        // Interests tag system
        document.getElementById('interestsInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                addInterest(this.value.trim());
                this.value = '';
            }
        });

        function addInterest(interest) {
            if (!interests.includes(interest)) {
                interests.push(interest);
                renderInterests();
                updateProgress();
            }
        }

        function removeInterest(interest) {
            interests = interests.filter(i => i !== interest);
            renderInterests();
            updateProgress();
        }

        function renderInterests() {
            const container = document.getElementById('interestsTags');
            container.innerHTML = interests.map(interest => 
                `<div class="tag">${interest} <span class="remove" onclick="removeInterest('${interest}')">√ó</span></div>`
            ).join('');
        }

        // Progress tracking
        function updateProgress() {
            let progress = 0;
            if (uploadedFile && extractedText) progress += 25;
            if (document.getElementById('background').value) progress += 25;
            if (interests.length > 0) progress += 25;
            if (document.getElementById('learningStyle').value) progress += 25;
            
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Event listeners for form updates
        ['background', 'experience', 'learningStyle', 'complexity'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateProgress);
        });

        // Generate personalized content with OpenAI API
        async function generatePersonalizedContent() {
            console.log('üîÑ Generate button clicked - starting validation...');
            
            const apiKey = document.getElementById('apiKey').value.trim();
            const background = document.getElementById('background').value;
            const experience = document.getElementById('experience').value;
            const learningStyle = document.getElementById('learningStyle').value;
            const complexity = document.getElementById('complexity').value;

            console.log('üìã Form data:', {
                apiKey: apiKey ? 'Present (length: ' + apiKey.length + ')' : 'Missing',
                background,
                experience,
                learningStyle,
                complexity,
                extractedText: extractedText ? 'Present (length: ' + extractedText.length + ')' : 'Missing',
                interests: interests.length
            });

            // Validation with detailed logging
            if (!apiKey) {
                console.log('‚ùå Validation failed: Missing API key');
                showStatus('Please enter your OpenAI API key.', 'error');
                return;
            }

            if (!uploadedFile) {
                console.log('‚ùå Validation failed: No file uploaded');
                showStatus('Please upload your slides first.', 'error');
                return;
            }

            if (!extractedText || extractedText.trim().length === 0) {
                console.log('‚ùå Validation failed: No extracted text');
                showStatus('No content was extracted from your file. Please try uploading again or use a different file format.', 'error');
                return;
            }

            if (!background) {
                console.log('‚ùå Validation failed: No background selected');
                showStatus('Please select your background.', 'error');
                return;
            }

            console.log('‚úÖ Validation passed - proceeding with API call...');

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="loading-spinner"></div>Generating with ChatGPT...';

            try {
                showStatus('ü§ñ ChatGPT is personalizing your content...', 'processing');
                
                console.log('üì° Calling OpenAI API...');
                const personalizedSlides = await callOpenAIAPI(apiKey, {
                    originalContent: extractedText,
                    background,
                    experience,
                    learningStyle,
                    complexity,
                    interests
                });

                console.log('‚úÖ API call successful, received slides:', personalizedSlides.length);
                
                personalizedContent = personalizedSlides;
                displayPersonalizedContent();
                showStatus('‚úÖ Your personalized slides are ready!', 'success');
                document.getElementById('outputSection').style.display = 'block';

            } catch (error) {
                console.error('‚ùå Full error details:', error);
                showStatus('‚ùå Error: ' + error.message, 'error');
                
                // Additional error details for debugging
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showStatus('‚ùå Network error - please check your internet connection and API key.', 'error');
                } else if (error.message.includes('401')) {
                    showStatus('‚ùå Invalid API key - please check your OpenAI API key.', 'error');
                } else if (error.message.includes('429')) {
                    showStatus('‚ùå Rate limit exceeded - please wait and try again.', 'error');
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üöÄ Generate Personalized Content with ChatGPT';
            }
        }

        // Call OpenAI API with enhanced slide-by-slide processing
        async function callOpenAIAPI(apiKey, userProfile) {
            console.log('üåê Making API call to OpenAI...');
            console.log('üìù Content preview:', userProfile.originalContent.substring(0, 200) + '...');
            
            const prompt = `You are an expert educational content personalizer. I have lecture slides content that needs to be personalized for a specific student.

Student Profile:
- Background: ${userProfile.background}
- Experience Level: ${userProfile.experience}
- Learning Style: ${userProfile.learningStyle}
- Content Complexity Preference: ${userProfile.complexity}
- Personal Interests: ${userProfile.interests.join(', ')}

Original Lecture Content:
${userProfile.originalContent}

CRITICAL INSTRUCTIONS for slide personalization:
1. ANALYZE each individual slide in the original content (marked with "--- Slide X ---")
2. For EVERY slide, you MUST:
   - Identify the core concept/topic of that specific slide
   - Rewrite the content with examples from the student's ${userProfile.background} background
   - Incorporate at least one reference to their interests: ${userProfile.interests.join(', ')}
   - Adjust complexity for ${userProfile.experience} level
   - Match their ${userProfile.learningStyle} learning style
3. PRESERVE the original slide structure and count
4. Each slide should be significantly different from the original while maintaining the learning objective
5. Use concrete, specific examples rather than generic ones

Please format your response as a JSON array where each slide is an object with 'title' and 'content' fields. 

EXAMPLE of good personalization:
Original: "Machine learning algorithms process data"
Personalized for journalism student interested in football: "Machine learning algorithms process data just like how sports journalists analyze player statistics to predict match outcomes. For instance, when Liverpool FC's analysts process Salah's shot data to optimize his positioning, they're using the same pattern recognition principles we'll explore."

Return EXACTLY this JSON format:
[
  {
    "title": "Slide 1 Title (personalized)",
    "content": "Detailed personalized explanation with specific examples from their background and interests..."
  },
  {
    "title": "Slide 2 Title (personalized)", 
    "content": "Another personalized explanation..."
  }
]

Ensure you create one JSON object for each slide found in the original content.`;

            try {
                console.log('üì° Sending request to OpenAI API...');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert educational content personalizer. Always respond with valid JSON arrays for slide content.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.7
                    })
                });

                console.log('üì® Response received, status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    
                    let errorMessage = `API request failed: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('‚úÖ API response parsed successfully');
                
                const gptResponse = data.choices[0].message.content;
                console.log('üìÑ GPT response preview:', gptResponse.substring(0, 300) + '...');

                // Try to parse JSON response
                try {
                    const jsonMatch = gptResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const parsedSlides = JSON.parse(jsonMatch[0]);
                        console.log('‚úÖ Successfully parsed', parsedSlides.length, 'slides');
                        return parsedSlides;
                    } else {
                        console.log('‚ö†Ô∏è No JSON array found, creating fallback slide');
                        return [{
                            title: "Personalized Content",
                            content: gptResponse
                        }];
                    }
                } catch (parseError) {
                    console.error('‚ùå JSON parse error:', parseError);
                    console.log('‚ö†Ô∏è Using fallback: treating entire response as content');
                    return [{
                        title: "Personalized Learning Content",
                        content: gptResponse
                    }];
                }
                
            } catch (networkError) {
                console.error('‚ùå Network/API Error:', networkError);
                
                // Provide helpful error messages for common issues
                if (networkError.message.includes('Failed to fetch')) {
                    throw new Error('üö´ Network Error: Please check your internet connection and API key.');
                }
                
                throw networkError;
            }
        }

        function displayPersonalizedContent() {
            const preview = document.getElementById('slidePreview');
            preview.innerHTML = personalizedContent.map((slide, index) => `
                <div class="slide-preview">
                    <div class="slide-title">Slide ${index + 1}: ${slide.title}</div>
                    <div class="slide-content">${slide.content}</div>
                </div>
            `).join('');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function exportToPDF() {
            if (!personalizedContent) return;
            
            showStatus('üìÑ Creating PDF presentation...', 'processing');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4'); // Landscape for slide format
                
                // PDF dimensions (A4 landscape)
                const pageWidth = 297;
                const pageHeight = 210;
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);
                
                // Get student profile info
                const background = document.getElementById('background').value;
                const experience = document.getElementById('experience').value;
                const interests = document.getElementById('interestsTags').textContent.replace(/√ó/g, '').trim();
                
                // Title page
                doc.setFillColor(79, 172, 254); // Blue background
                doc.rect(0, 0, pageWidth, 50, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('Personalized Learning Content', pageWidth/2, 30, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Background: ${background}`, margin, 80);
                doc.text(`Experience Level: ${experience}`, margin, 95);
                doc.text(`Interests: ${interests || 'General'}`, margin, 110);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, 125);
                
                // Add slides
                personalizedContent.forEach((slideData, index) => {
                    doc.addPage('landscape');
                    
                    // Slide header background
                    doc.setFillColor(240, 248, 255); // Light blue
                    doc.rect(0, 0, pageWidth, 40, 'F');
                    
                    // Slide number
                    doc.setTextColor(79, 172, 254);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Slide ${index + 1}`, margin, 15);
                    
                    // Slide title
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    const title = slideData.title;
                    const titleLines = doc.splitTextToSize(title, contentWidth);
                    doc.text(titleLines, margin, 30);
                    
                    // Slide content
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    const content = slideData.content;
                    
                    // Split content into paragraphs and format
                    const paragraphs = content.split('\n').filter(p => p.trim());
                    let yPosition = 60;
                    
                    paragraphs.forEach(paragraph => {
                        if (yPosition > pageHeight - 30) return; // Prevent overflow
                        
                        const lines = doc.splitTextToSize(paragraph.trim(), contentWidth);
                        doc.text(lines, margin, yPosition);
                        yPosition += lines.length * 6 + 8; // Line spacing + paragraph spacing
                    });
                    
                    // Add footer
                    doc.setTextColor(150, 150, 150);
                    doc.setFontSize(8);
                    doc.text('Generated by Personalized AI Learning Platform', pageWidth/2, pageHeight - 10, { align: 'center' });
                });
                
                // Save the PDF
                const fileName = `personalized-slides-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showStatus('‚úÖ PDF presentation downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showStatus('‚ùå Error creating PDF: ' + error.message, 'error');
            }
        }

        function exportToPowerPoint() {
            if (!personalizedContent) return;
            
            showStatus('üìä Creating PowerPoint presentation...', 'processing');
            
            try {
                // Create new PowerPoint presentation
                const pptx = new PptxGenJS();
                
                // Set presentation properties
                pptx.author = 'Personalized AI Learning Platform';
                pptx.company = 'AI Education';
                pptx.subject = 'Personalized Learning Content';
                pptx.title = 'Customized Lecture Slides';
                
                // Define slide layout and styling
                const slideLayout = {
                    name: 'LAYOUT_16x9',
                    width: 10,
                    height: 5.625
                };
                
                // Add title slide
                const titleSlide = pptx.addSlide();
                titleSlide.addText('Personalized Learning Content', {
                    x: 1,
                    y: 1.5,
                    w: 8,
                    h: 1.5,
                    fontSize: 32,
                    bold: true,
                    color: '4FACFE',
                    align: 'center'
                });
                
                const background = document.getElementById('background').value;
                const interests = document.getElementById('interestsTags').textContent.replace(/√ó/g, '').trim();
                
                titleSlide.addText(`Customized for: ${background} background\nInterests: ${interests || 'General'}`, {
                    x: 1,
                    y: 3,
                    w: 8,
                    h: 1,
                    fontSize: 14,
                    color: '666666',
                    align: 'center'
                });
                
                // Add each personalized slide
                personalizedContent.forEach((slideData, index) => {
                    const slide = pptx.addSlide();
                    
                    // Add slide title
                    slide.addText(slideData.title, {
                        x: 0.5,
                        y: 0.3,
                        w: 9,
                        h: 0.8,
                        fontSize: 24,
                        bold: true,
                        color: '333333'
                    });
                    
                    // Add slide content
                    const content = slideData.content.length > 800 ? 
                        slideData.content.substring(0, 800) + '...' : 
                        slideData.content;
                    
                    slide.addText(content, {
                        x: 0.5,
                        y: 1.3,
                        w: 9,
                        h: 3.8,
                        fontSize: 14,
                        color: '444444',
                        valign: 'top',
                        lineSpacing: 20
                    });
                    
                    // Add slide number
                    slide.addText(`${index + 1}`, {
                        x: 9.2,
                        y: 5,
                        w: 0.5,
                        h: 0.3,
                        fontSize: 10,
                        color: '999999',
                        align: 'center'
                    });
                });
                
                // Save the presentation
                const fileName = `personalized-slides-${new Date().toISOString().split('T')[0]}.pptx`;
                pptx.writeFile({ fileName: fileName });
                
                showStatus('‚úÖ PowerPoint presentation downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PowerPoint export error:', error);
                showStatus('‚ùå Error creating PowerPoint: ' + error.message, 'error');
            }
        }

        function exportToText() {
            if (!personalizedContent) return;
            
            const content = personalizedContent.map((slide, index) => 
                `Slide ${index + 1}: ${slide.title}\n\n${slide.content}\n\n${'='.repeat(50)}\n\n`
            ).join('');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'personalized-slides.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function copyToClipboard() {
            if (!personalizedContent) return;
            
            const content = personalizedContent.map((slide, index) => 
                `Slide ${index + 1}: ${slide.title}\n\n${slide.content}\n\n`
            ).join('---\n\n');
            
            try {
                await navigator.clipboard.writeText(content);
                showStatus('‚úÖ Content copied to clipboard!', 'success');
            } catch (err) {
                showStatus('‚ùå Failed to copy to clipboard', 'error');
            }
        }

        // Load saved API key
        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('openaiApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        });

        // Save API key when entered
        document.getElementById('apiKey').addEventListener('input', function() {
            localStorage.setItem('openaiApiKey', this.value);
        });
    </script>
</body>
</html>